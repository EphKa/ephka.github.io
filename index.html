<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Grid Territory Game</title>
<style>
  body,html{margin:0;padding:0;height:100%;font-family:sans-serif}
  .screen{display:none;width:100%;height:100%}
  .active{display:flex}
  #menuScreen,#multiplayerScreen{flex-direction:column;align-items:center;justify-content:center}
  #menuScreen button,#multiplayerScreen button{margin:8px;padding:12px 24px;font-size:1rem}
  #hostPanel,#joinPanel{display:none;flex-direction:column;align-items:center;justify-content:center;margin-top:16px;width:90%;max-width:480px}
  #hostPanel p,#joinPanel p{margin:4px 0}
  #hostPanel textarea,#joinPanel textarea{width:100%;height:110px}
  #hostPanel input,#joinPanel input{padding:8px;width:240px;margin:4px 0}
  #gameScreen{display:flex}
  #left{flex:2;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f0f0f0}
  #right{flex:1;overflow:auto;padding:16px;box-sizing:border-box}
  h2{margin:8px 0}
  #game-container{position:relative;width:420px;height:420px}
  canvas{position:absolute;top:0;left:0;background:#fff}
  #info{margin-top:8px;font-weight:600}
  #debug{margin-top:8px;font-size:.8em;color:#a00;white-space:pre-wrap;text-align:left;width:90%}
  #lobby{margin-bottom:16px}
  #chatLog{height:120px;overflow-y:auto;border:1px solid #ccc;padding:4px;background:#fff}
  #chatContainer input{width:70%;padding:4px}
  #chatContainer button{width:25%;padding:4px}
</style>
</head>
<body>
<!-- MAIN MENU -->
<div id="menuScreen" class="screen active">
  <h2>Grid Territory Game</h2>
  <button id="localBtn">Local Play</button>
  <button id="multiBtn">Multiplayer</button>
</div>

<!-- MULTIPLAYER SCREEN -->
<div id="multiplayerScreen" class="screen">
  <h2>Multiplayer Mode</h2>
  <button id="hostBtn">Host Game</button>
  <button id="showJoinBtn">Join Game</button>
  <button id="backBtn">Back</button>

  <!-- HOST PANEL -->
  <div id="hostPanel">
    <p><strong>1. Share this OFFER with your friend</strong></p>
    <textarea id="hostOffer" readonly></textarea>
    <button id="copyOfferBtn">Copy Offer</button>

    <p><strong>2. Paste the ANSWER you receive and click “Set Answer”</strong></p>
    <textarea id="hostAnswer"></textarea>
    <button id="setAnswerBtn">Set Answer</button>

    <p>Status: <span id="hostStatus">Idle</span></p>
  </div>

  <!-- JOIN PANEL -->
  <div id="joinPanel">
    <p><strong>1. Paste the host’s OFFER here and press “Accept Offer”</strong></p>
    <textarea id="joinOffer"></textarea>
    <button id="acceptOfferBtn">Accept Offer</button>

    <p><strong>2. Send this ANSWER back to the host</strong></p>
    <textarea id="joinAnswer" readonly></textarea>
    <button id="copyAnswerBtn">Copy Answer</button>

    <p>Status: <span id="joinStatus">Idle</span></p>
  </div>
</div>

<!-- GAME & CHAT SCREEN -->
<div id="gameScreen" class="screen">
  <div id="left">
    <h2>Grid Territory</h2>
    <div id="game-container"><canvas id="gameCanvas" width="420" height="420"></canvas></div>
    <div id="info">Game not started</div>
    <div id="debug"></div>
  </div>
  <div id="right">
    <div id="lobby">
      <h4>Lobby</h4>
      <div id="lobbyStatus">Waiting…</div>
    </div>
    <div id="chatContainer">
      <h4>Chat</h4>
      <div id="chatLog"></div>
      <input id="chatInput" type="text" placeholder="Type…"/>
      <button id="sendChat">Send</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
/* ---------- Shortcuts to DOM ---------- */
const $ = id => document.getElementById(id);
const menuScreen=$('menuScreen'), multiScreen=$('multiplayerScreen'), gameScreen=$('gameScreen');
const showScreen = s => [menuScreen,multiScreen,gameScreen].forEach(x=>x.classList.toggle('active',x===s));

/* ---------- Navigation buttons ---------- */
$('localBtn').onclick=()=>{modeLocal();};
$('multiBtn').onclick=()=>showScreen(multiScreen);
$('backBtn').onclick =()=>showScreen(menuScreen);

/* ---------- WebRTC Essentials ---------- */
let pc, dataChannel;
const rtcConfig={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
function newPeer(){pc=new RTCPeerConnection(rtcConfig);pc.onconnectionstatechange=e=>console.log('pc state',pc.connectionState);}
function waitIceComplete(peer){return new Promise(res=>{if(peer.iceGatheringState==='complete')return res();
  peer.onicegatheringstatechange=()=>peer.iceGatheringState==='complete'&&res();});
}

/* ---------- Host flow ---------- */
$('hostBtn').onclick=async()=>{
  showScreen(multiScreen);$('hostPanel').style.display='flex';$('joinPanel').style.display='none';
  $('hostStatus').textContent='Creating offer…';
  newPeer();
  dataChannel=pc.createDataChannel('game');
  dataChannel.onopen=onChannelOpen;
  dataChannel.onmessage=handleDataMessage;

  await pc.setLocalDescription(await pc.createOffer());
  await waitIceComplete(pc);
  $('hostOffer').value = JSON.stringify(pc.localDescription);
  $('hostStatus').textContent='Send the offer to your friend';
};
$('copyOfferBtn').onclick=()=>navigator.clipboard.writeText($('hostOffer').value);
$('setAnswerBtn').onclick=async()=>{
  try{
    const ans=JSON.parse($('hostAnswer').value.trim());
    await pc.setRemoteDescription(ans);
    $('hostStatus').textContent='Answer accepted, waiting for data channel…';
  }catch(e){alert('Invalid answer');}
};

/* ---------- Join flow ---------- */
$('showJoinBtn').onclick=()=>{
  showScreen(multiScreen);$('joinPanel').style.display='flex';$('hostPanel').style.display='none';
};
$('acceptOfferBtn').onclick=async()=>{
  try{
    newPeer();
    pc.ondatachannel=e=>{dataChannel=e.channel;dataChannel.onmessage=handleDataMessage;dataChannel.onopen=onChannelOpen;};
    const offer=JSON.parse($('joinOffer').value.trim());
    await pc.setRemoteDescription(offer);
    await pc.setLocalDescription(await pc.createAnswer());
    await waitIceComplete(pc);
    $('joinAnswer').value=JSON.stringify(pc.localDescription);
    $('joinStatus').textContent='Copy this answer back to host';
  }catch(e){alert('Invalid offer');}
};
$('copyAnswerBtn').onclick=()=>navigator.clipboard.writeText($('joinAnswer').value);

/* ---------- Chat ---------- */
$('sendChat').onclick=()=>{
  const txt=$('chatInput').value.trim();
  if(!txt||!dataChannel||dataChannel.readyState!=='open')return;
  appendChat(localPlayer,txt);
  dataChannel.send(JSON.stringify({type:'chat',from:localPlayer,text:txt}));
  $('chatInput').value='';
};
function appendChat(p,txt){
  const div=document.createElement('div');
  div.innerHTML=`<strong>P${p}:</strong> ${txt}`;
  $('chatLog').appendChild(div);
  $('chatLog').scrollTop=$('chatLog').scrollHeight;
}

/* ---------- Game state ---------- */
const gridSize=21, cellPx=20, canvas=$('gameCanvas'), ctx=canvas.getContext('2d');
let isMultiplayer=false, localPlayer=1, turn=1, gameStarted=false;
let lines,nodes,horiz,vert,cells,clickStart=null,hoverEnd=null;

const px2g=px=>Math.round(px/cellPx), g2px=g=>g*cellPx;

function initGameState(){
  turn=1;
  lines=[];
  nodes=Array.from({length:gridSize},()=>Array(gridSize).fill(false));
  horiz=Array.from({length:gridSize},()=>Array(gridSize-1).fill(false));
  vert=Array.from({length:gridSize-1},()=>Array(gridSize).fill(false));
  cells=Array.from({length:gridSize-1},()=>Array(gridSize-1).fill(0));
  clickStart=null;hoverEnd=null;
  gameStarted=!isMultiplayer;
  $('info').textContent=gameStarted?`Turn: Player ${turn}`:'Waiting to start';
}
function onChannelOpen(){
  $('lobbyStatus').textContent='Connected!';
  dataChannel.send(JSON.stringify({type:'hello'}));
  isMultiplayer=true;
  localPlayer=dataChannel.label==='game'?1:2; // Host is always 1
  beginGame();
}
function beginGame(){initGameState();showScreen(gameScreen);draw();}

/* ---------- Board logic ---------- */
function isStraight3(sx,sy,ex,ey){
  const dx=Math.abs(ex-sx),dy=Math.abs(ey-sy);
  return (dx===3&&dy===0)||(dx===0&&dy===3);
}
function interiorPoints(sx,sy,ex,ey){
  if(sx===ex){const y0=Math.min(sy,ey);return[{x:sx,y:y0+1},{x:sx,y:y0+2}];}
  const x0=Math.min(sx,ex);return[{x:x0+1,y:sy},{x:x0+2,y:sy}];
}
function noIllegalCrossing(sx,sy,ex,ey){
  const ni=interiorPoints(sx,sy,ex,ey);
  for(const ln of lines){
    const oi=interiorPoints(ln.sx,ln.sy,ln.ex,ln.ey);
    for(const a of ni)for(const b of oi)if(a.x===b.x&&a.y===b.y)return false;
  }return true;
}
function touchesExisting(sx,sy,ex,ey){
  return lines.length===0||nodes[sy][sx]||nodes[ey][ex];
}
function detectTerritories(player){
  const visited=Array.from({length:gridSize-1},()=>Array(gridSize-1).fill(false));
  const queue=[];
  for(let i=0;i<gridSize-1;i++){
    [[0,i],[gridSize-2,i],[i,0],[i,gridSize-2]].forEach(([x,y])=>{
      if(!visited[y][x]){visited[y][x]=true;queue.push({x,y});}});
  }
  const canPass=(x,y,nx,ny)=>{
    if(x===nx){const hy=Math.min(y,ny)+1;return !horiz[hy][x];}
    const vx=Math.min(x,nx)+1;return !vert[y][vx];
  };
  while(queue.length){
    const{ x,y }=queue.shift();
    [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{
      const nx=x+dx,ny=y+dy;
      if(nx>=0&&nx<gridSize-1&&ny>=0&&ny<gridSize-1&&!visited[ny][nx]&&canPass(x,y,nx,ny)){
        visited[ny][nx]=true;queue.push({x:nx,y:ny});
      }
    });
  }
  for(let y=0;y<gridSize-1;y++)for(let x=0;x<gridSize-1;x++){
    if(!visited[y][x]&&cells[y][x]===0)cells[y][x]=player;
  }
}
function occupy(sx,sy,ex,ey,player){
  lines.push({sx,sy,ex,ey,player});
  if(sx===ex){
    const x=sx,y0=Math.min(sy,ey);
    for(let d=0;d<3;d++){vert[y0+d][x]=true;nodes[y0+d][x]=nodes[y0+d+1][x]=true;}
  }else{
    const y=sy,x0=Math.min(sx,ex);
    for(let d=0;d<3;d++){horiz[y][x0+d]=true;nodes[y][x0+d]=nodes[y][x0+1+d]=true;}
  }
  detectTerritories(player);
}

function draw(){
  ctx.clearRect(0,0,420,420);
  ctx.strokeStyle='#ddd';ctx.lineWidth=1;
  for(let i=0;i<=gridSize;i++){const p=g2px(i);
    ctx.beginPath();ctx.moveTo(p,0);ctx.lineTo(p,420);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,p);ctx.lineTo(420,p);ctx.stroke();
  }
  for(let y=0;y<gridSize-1;y++)for(let x=0;x<gridSize-1;x++){
    if(cells[y][x]>0){ctx.globalAlpha=.2;ctx.fillStyle=cells[y][x]==1?'red':'blue';
      ctx.fillRect(g2px(x),g2px(y),cellPx,cellPx);ctx.globalAlpha=1;}
  }
  for(const ln of lines){
    ctx.beginPath();ctx.lineWidth=4;ctx.strokeStyle=ln.player==1?'red':'blue';
    ctx.moveTo(g2px(ln.sx),g2px(ln.sy));ctx.lineTo(g2px(ln.ex),g2px(ln.ey));ctx.stroke();
  }
  if(clickStart&&hoverEnd){ctx.beginPath();ctx.setLineDash([5,5]);ctx.lineWidth=2;ctx.strokeStyle='gray';
    ctx.moveTo(g2px(clickStart.x),g2px(clickStart.y));ctx.lineTo(g2px(hoverEnd.x),g2px(hoverEnd.y));ctx.stroke();ctx.setLineDash([]);}
  $('info').textContent=gameStarted?`Turn: Player ${turn}`:'Waiting to start';
}

/* ---------- Canvas events ---------- */
canvas.addEventListener('mousemove',e=>{
  if(!clickStart||!gameStarted)return;
  const r=canvas.getBoundingClientRect();
  hoverEnd={x:px2g(e.clientX-r.left),y:px2g(e.clientY-r.top)};
  draw();
});
canvas.addEventListener('click',e=>{
  if(!gameStarted)return;
  if(localPlayer!==turn){$('debug').textContent='Not your turn';return;}
  const r=canvas.getBoundingClientRect();
  const gx=px2g(e.clientX-r.left),gy=px2g(e.clientY-r.top);
  if(!clickStart){clickStart={x:gx,y:gy};hoverEnd=null;return;}
  const{ x:sx,y:sy }=clickStart;
  const{ x:ex,y:ey }=hoverEnd||{x:gx,y:gy};
  if(!isStraight3(sx,sy,ex,ey)){$('debug').textContent='Must be straight length 3';}
  else if(!touchesExisting(sx,sy,ex,ey)){$('debug').textContent='Must touch existing';}
  else if(!noIllegalCrossing(sx,sy,ex,ey)){$('debug').textContent='Illegal crossing';}
  else{
    occupy(sx,sy,ex,ey,turn);
    if(isMultiplayer&&dataChannel?.readyState==='open'){
      dataChannel.send(JSON.stringify({type:'move',sx,sy,ex,ey,player:turn}));
    }
    turn=turn===1?2:1;draw();
  }
  clickStart=hoverEnd=null;
});

/* ---------- Data channel messaging ---------- */
function handleDataMessage(evt){
  const msg=JSON.parse(evt.data);
  if(msg.type==='move'){
    occupy(msg.sx,msg.sy,msg.ex,msg.ey,msg.player);
    turn=msg.player===1?2:1;draw();
  }else if(msg.type==='chat'){
    appendChat(msg.from,msg.text);
  }
}

/* ---------- Local play ---------- */
function modeLocal(){isMultiplayer=false;localPlayer=1;initGameState();showScreen(gameScreen);draw();$('lobbyStatus').textContent='Local two‑player ‑ swap turns on the same device';}

initGameState();
});
</script>
</body>
</html>
