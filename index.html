<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grid Territory — 100 % server‑less WebRTC</title>

<style>
 body,html{margin:0;height:100%;font-family:sans-serif}
 .screen{display:none;width:100%;height:100%}
 .active{display:flex}
 #menuScreen,#multiScreen{flex-direction:column;align-items:center;justify-content:center}
 button{margin:8px 0;padding:12px 24px;font-size:1rem}
 textarea{width:100%;height:110px}
 #hostBox,#joinBox{display:none;flex-direction:column;align-items:center;margin-top:16px;width:90%;max-width:480px}
 #gameScreen{display:flex}
 #left{flex:2;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f0f0f0}
 #right{flex:1;overflow-y:auto;padding:16px;box-sizing:border-box}
 #game-container{position:relative;width:420px;height:420px}
 canvas{position:absolute;top:0;left:0;background:#fff}
 #info{margin-top:8px;font-weight:600}
 #debug{margin-top:8px;font-size:.8em;color:#a00;white-space:pre-wrap;width:90%}
 #chatLog{height:120px;overflow-y:auto;border:1px solid #ccc;padding:4px;background:#fff}
 #chatInput{width:70%;padding:4px}
 #sendBtn{width:25%;padding:4px}
</style>
</head>
<body>

<!-- ── MENU ────────────────────────────────────────────────────────────── -->
<div id="menuScreen" class="screen active">
  <h2>Grid Territory</h2>
  <button id="localBtn">Local Play</button>
  <button id="multiBtn">Multiplayer</button>
</div>

<!-- ── MULTIPLAYER SETUP ───────────────────────────────────────────────── -->
<div id="multiScreen" class="screen">
  <h2>Multiplayer Mode (No Server)</h2>
  <button id="hostBtn">Host Game</button>
  <button id="joinBtn">Join Game</button>
  <button id="backBtn">Back</button>

  <div id="hostBox">
    <p><strong>1.&nbsp;Send this OFFER to your friend</strong></p>
    <textarea id="offerOut" readonly></textarea>
    <button id="copyOffer">Copy Offer</button>

    <p><strong>2.&nbsp;Paste their ANSWER here</strong></p>
    <textarea id="answerIn"></textarea>
    <button id="setAnswer">Set Answer</button>

    <p>Status: <span id="hostStatus">Idle</span></p>
  </div>

  <div id="joinBox">
    <p><strong>1.&nbsp;Paste the host’s OFFER here</strong></p>
    <textarea id="offerIn"></textarea>
    <button id="acceptOffer">Accept Offer</button>

    <p><strong>2.&nbsp;Send this ANSWER back to host</strong></p>
    <textarea id="answerOut" readonly></textarea>
    <button id="copyAnswer">Copy Answer</button>

    <p>Status: <span id="joinStatus">Idle</span></p>
  </div>
</div>

<!-- ── GAME SCREEN ─────────────────────────────────────────────────────── -->
<div id="gameScreen" class="screen">
  <div id="left">
    <h2>Grid Territory</h2>
    <div id="game-container"><canvas id="cv" width="420" height="420"></canvas></div>
    <div id="info">Game not started</div>
    <div id="debug"></div>
  </div>
  <div id="right">
    <h4>Chat</h4>
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Type…">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
/* ── DOM helpers ─────────────────────────────────────────────────── */
const $=id=>document.getElementById(id);
const   menu=$('menuScreen'), multi=$('multiScreen'), game=$('gameScreen');
function show(s){[menu,multi,game].forEach(x=>x.classList.toggle('active',x===s));}

/* ── Navigation ─────────────────────────────────────────────────── */
$('localBtn').onclick=localMode;
$('multiBtn').onclick=()=>show(multi);
$('backBtn').onclick =()=>show(menu);

/* ── WebRTC: no external signalling ─────────────────────────────── */
const rtcCfg={
  iceServers:[
    {urls:'stun:stun.l.google.com:19302'}
    // add free TURN if desired:
    // {urls:['turn:openrelay.metered.ca:80','turn:openrelay.metered.ca:443',
    //        'turns:openrelay.metered.ca:443?transport=tcp'],
    //  username:'openrelayproject',credential:'openrelayproject'}
  ]
};
let pc,dc,isHost=false;

/* ── Host flow ──────────────────────────────────────────────────── */
$('hostBtn').onclick=async ()=>{
  isHost=true; $('hostBox').style.display='flex'; $('joinBox').style.display='none'; show(multi);
  pc=new RTCPeerConnection(rtcCfg);
  dc=pc.createDataChannel('g');
  dc.onopen=startGame;  dc.onmessage=onMsg;
  await pc.setLocalDescription(await pc.createOffer());
  await waitIce(pc);
  $('offerOut').value=JSON.stringify(pc.localDescription);
  $('hostStatus').textContent='Waiting for answer…';
};
$('copyOffer').onclick =()=>navigator.clipboard.writeText($('offerOut').value);
$('setAnswer').onclick =async ()=>{
  try{
    const ans=JSON.parse($('answerIn').value.trim());
    await pc.setRemoteDescription(ans);
    $('hostStatus').textContent='Answer set, connecting…';
  }catch(e){alert('Invalid JSON');}
};

/* ── Join flow ──────────────────────────────────────────────────── */
$('joinBtn').onclick =()=>{isHost=false; $('joinBox').style.display='flex'; $('hostBox').style.display='none'; show(multi);};
$('acceptOffer').onclick=async ()=>{
  try{
    pc=new RTCPeerConnection(rtcCfg);
    pc.ondatachannel=e=>{dc=e.channel; dc.onopen=startGame; dc.onmessage=onMsg;};
    const off=JSON.parse($('offerIn').value.trim());
    await pc.setRemoteDescription(off);
    await pc.setLocalDescription(await pc.createAnswer());
    await waitIce(pc);
    $('answerOut').value=JSON.stringify(pc.localDescription);
    $('joinStatus').textContent='Send the answer back!';
  }catch(e){alert('Invalid JSON');}
};
$('copyAnswer').onclick=()=>navigator.clipboard.writeText($('answerOut').value);

/* ── wait for ICE gather done ───────────────────────────────────── */
function waitIce(p){return new Promise(r=>{
  if(p.iceGatheringState==='complete')return r();
  p.onicegatheringstatechange=()=>p.iceGatheringState==='complete'&&r();
});}

/* ── Chat ───────────────────────────────────────────────────────── */
$('sendBtn').onclick=()=>{
  const txt=$('chatInput').value.trim(); if(!txt)return;
  addChat(localPlayer,txt); if(dc?.readyState==='open')dc.send(JSON.stringify({type:'chat',from:localPlayer,text:txt}));
  $('chatInput').value='';
};
function addChat(p,msg){const d=document.createElement('div');d.innerHTML=`<b>P${p}:</b> ${msg}`;$('chatLog').append(d);$('chatLog').scrollTop=$('chatLog').scrollHeight;}
function onMsg(e){const m=JSON.parse(e.data); if(m.type==='chat')addChat(m.from,m.text); else if(m.type==='move')remoteMove(m);}

/* ── Game logic (unchanged from earlier) ────────────────────────── */
const N=21,S=20,cv=$('cv'),ctx=cv.getContext('2d');
let turn=1,localPlayer=1,lines,nodes,h,v,cells,click=null,hover=null,playing=false;

function localMode(){isHost=false;playing=false;init();show(game);}
function startGame(){localPlayer=isHost?1:2;playing=true;init();show(game);}
function init(){turn=1;lines=[];nodes=grid(N,N,false);h=grid(N,N-1,false);v=grid(N-1,N,false);cells=grid(N-1,N-1,0);click=hover=null;draw();}
const grid=(a,b,val)=>Array.from({length:a},()=>Array(b).fill(val));
function idx(px){return Math.round(px/S);} function px(i){return i*S;}
function interior(sx,sy,ex,ey){if(sx===ex){const y=Math.min(sy,ey);return[{x:sx,y:y+1},{x:sx,y:y+2}];}const x=Math.min(sx,ex);return[{x:x+1,y:sy},{x:x+2,y:sy}];}
function cross(sx,sy,ex,ey){const inA=interior(sx,sy,ex,ey);return lines.some(l=>interior(l.sx,l.sy,l.ex,l.ey).some(a=>inA.some(b=>a.x===b.x&&a.y===b.y)));}
function touch(sx,sy,ex,ey){return lines.length===0||nodes[sy][sx]||nodes[ey][ex];}
function occupy(sx,sy,ex,ey,p){
  lines.push({sx,sy,ex,ey,p});
  if(sx===ex){const x=sx,y=Math.min(sy,ey);for(let d=0;d<3;d++){v[y+d][x]=true;nodes[y+d][x]=nodes[y+d+1][x]=true;}}
  else{const y=sy,x=Math.min(sx,ex);for(let d=0;d<3;d++){h[y][x+d]=true;nodes[y][x+d]=nodes[y][x+1+d]=true;}}
  fill(p);
}
function fill(p){
  const vis=grid(N-1,N-1,false),q=[];
  for(let i=0;i<N-1;i++)[[0,i],[N-2,i],[i,0],[i,N-2]].forEach(([x,y])=>{vis[y][x]=true;q.push({x,y});});
  const pass=(x,y,nx,ny)=>x===nx?!h[Math.min(y,ny)+1][x]:!v[y][Math.min(x,nx)+1];
  while(q.length){const{ x,y}=q.shift();[[1,0],[-1,0],[0,1],[0,-1]].forEach(([dx,dy])=>{
    const nx=x+dx,ny=y+dy;if(nx>=0&&ny>=0&&nx<N-1&&ny<N-1&&!vis[ny][nx]&&pass(x,y,nx,ny)){vis[ny][nx]=true;q.push({x:nx,y:ny});}});
  }
  for(let y=0;y<N-1;y++)for(let x=0;x<N-1;x++)if(!vis[y][x]&&!cells[y][x])cells[y][x]=p;
}
function draw(){
  ctx.clearRect(0,0,420,420);
  ctx.strokeStyle='#ddd';ctx.lineWidth=1;
  for(let i=0;i<=N;i++){ctx.beginPath();ctx.moveTo(px(i),0);ctx.lineTo(px(i),420);ctx.stroke();ctx.beginPath();ctx.moveTo(0,px(i));ctx.lineTo(420,px(i));ctx.stroke();}
  for(let y=0;y<N-1;y++)for(let x=0;x<N-1;x++)if(cells[y][x]){ctx.globalAlpha=.2;ctx.fillStyle=cells[y][x]==1?'red':'blue';ctx.fillRect(px(x),px(y),S,S);ctx.globalAlpha=1;}
  for(const l of lines){ctx.beginPath();ctx.lineWidth=4;ctx.strokeStyle=l.p==1?'red':'blue';ctx.moveTo(px(l.sx),px(l.sy));ctx.lineTo(px(l.ex),px(l.ey));ctx.stroke();}
  if(click&&hover){ctx.beginPath();ctx.setLineDash([4,4]);ctx.lineWidth=2;ctx.strokeStyle='gray';ctx.moveTo(px(click.x),px(click.y));ctx.lineTo(px(hover.x),px(hover.y));ctx.stroke();ctx.setLineDash([]);}
  $('info').textContent=playing?`Turn ${turn}`:'Waiting…';
}
cv.onmousemove=e=>{if(!click||!playing)return;const r=cv.getBoundingClientRect();hover={x:idx(e.clientX-r.left),y:idx(e.clientY-r.top)};draw();};
cv.onclick=e=>{
  if(!playing)return;
  if(isHost||(!isHost&&dc?.readyState!=='open')){} // local still OK
  if(click==null){const r=cv.getBoundingClientRect();click={x:idx(e.clientX-r.left),y:idx(e.clientY-r.top)};return;}
  const r=cv.getBoundingClientRect();const ex=idx(e.clientX-r.left),ey=idx(e.clientY-r.top);
  const {x:sx,y:sy}=click;
  if(!(Math.abs(ex-sx)===3^Math.abs(ey-sy)===3)^false){$('debug').textContent='Must be straight len 3';click=null;hover=null;draw();return;}
  if(!touch(sx,sy,ex,ey)){$('debug').textContent='Must touch existing';}else if(cross(sx,sy,ex,ey)){$('debug').textContent='Illegal crossing';}else{
      occupy(sx,sy,ex,ey,turn);
      if(dc?.readyState==='open')dc.send(JSON.stringify({type:'move',sx,sy,ex,ey,p:turn}));
      turn=turn===1?2:1;$('debug').textContent='';
  }
  click=hover=null;draw();
};
/* Remote move handler */function remoteMove(m){occupy(m.sx,m.sy,m.ex,m.ey,m.p);turn=m.p===1?2:1;draw();}

/* ── Kick off ────────────────────────────────────────────────────── */
localMode();  // default screen
</script>
</body>
</html>
