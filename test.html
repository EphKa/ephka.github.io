<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>GitHubÂ Pages P2Pâ€¯ChatÂ â€“â€¯PeerJSÂ 1.5.x</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:sans-serif;max-width:560px;margin:40px auto;padding:0 1rem}
  #log{border:1px solid #ccc;height:240px;overflow-y:auto;padding:8px;margin:8px 0;white-space:pre-wrap;background:#fafafa}
  #controls>*{margin:.4rem 0}
  #remote-id{width:100%}
</style>
<!-- Pin the exact version so a future update canâ€™t break your page -->
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
<h2>Peerâ€‘toâ€‘Peer chat test</h2>

<p>Your ID: <strong id="my-id">â€¦</strong></p>

<div id="controls">
  <label>
    Connect to peer ID:
    <input id="remote-id" placeholder="paste partnerâ€™s ID">
  </label>
  <button id="btn-connect" disabled>Connect</button>
</div>

<div id="status">Status: <em>initialisingâ€¦</em></div>

<div id="log"></div>

<form id="form-msg" style="display:none">
  <input id="msg" autocomplete="off" placeholder="type message" style="width:75%">
  <button>Send</button>
</form>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1.  Peer setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const peer = new Peer({
  debug : 3,                                       // verbose console logs
  config: {                                        // STUN first; add TURN later if needed
    iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ]
  }
});

const $ = id => document.getElementById(id);
const logBox = $('log');
let   conn   = null;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2.  Bootstrap after Peerâ€‘Server handshake â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
peer.on('open', id => {
  $('my-id').textContent   = id;
  $('status').textContent  = 'Status: waitingâ€¦';
  $('btn-connect').disabled = false;              // user can now press â€œConnectâ€
  console.info('âœ”ï¸  Peer socket open â€“ ready, id =', id);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3.  Diagnostic helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
peer.on('error',   e => { console.error(e);  log(`âš ï¸ ${e.type}: ${e.message}`); });
peer.on('disconnected',  ()=> log('âš ï¸ lost connection to signalling server'));
peer.on('close',         ()=> log('âš ï¸ peer instance shut down'));

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4.  Incoming connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
peer.on('connection', c => {
  if (conn) c.close();                            // only one chat at a time
  setUpConn(c);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5.  Outgoing connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('btn-connect').onclick = () => {
  const id = $('remote-id').value.trim();
  if (!id) return alert('Enter a peer ID first!');
  if (!peer.open) return alert('Still initialising, try again in a sec');
  setUpConn(peer.connect(id));
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6.  Shared DataConnection plumbing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setUpConn(c){
  conn = c;
  $('status').textContent = `Status: connecting to ${c.peer}â€¦`;
  c.on('open', () => {
    $('status').textContent  = `Status: ðŸŸ¢ connected to ${c.peer}`;
    $('form-msg').style.display = '';
    log(`ðŸŸ¢ Connected to ${c.peer}`);
  });
  c.on('data',  d => log(`ðŸ‘¤Â ${c.peer}: ${d}`));
  c.on('close', () => {
    log(`âŒ Connection to ${c.peer} closed`);
    $('status').textContent  = 'Status: disconnected';
    $('form-msg').style.display = 'none';
    conn = null;
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7.  Sendâ€‘message form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('form-msg').addEventListener('submit', e=>{
  e.preventDefault();
  const txt = $('msg').value.trim();
  if (!txt || !conn?.open) return;
  conn.send(txt);
  log(`ðŸ˜ŠÂ Me: ${txt}`);
  e.target.reset();
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8.  Tiny logger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function log(t){
  logBox.textContent += t + '\n';
  logBox.scrollTop    = logBox.scrollHeight;
}
</script>
</body>
</html>
