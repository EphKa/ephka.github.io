<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Peerâ€‘toâ€‘Peer Chat (PeerJS)</title>
<style>
  body{font-family:sans-serif;max-width:540px;margin:40px auto}
  #log{border:1px solid #ccc;height:240px;overflow-y:auto;padding:8px;margin-bottom:8px;white-space:pre-wrap}
  #controls > *{margin:4px 0}
</style>
<!-- Pin an exact library version so future releases can't break you -->
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
<h2>P2Pâ€¯Chat test</h2>

<div id="controls">
  <p>Your ID: <strong id="my-id">â€¦</strong></p>

  <label>
    Connect to peer ID:
    <input id="remote-id" placeholder="paste partner's ID" />
    <button id="btn-connect">Connect</button>
  </label>
</div>

<div id="status">Status: <em>waiting for connectionâ€¦</em></div>

<div id="log"></div>

<form id="form-msg" style="display:none">
  <input id="msg" autocomplete="off" placeholder="type message" style="width:70%" />
  <button>Send</button>
</form>

<script>
/* ---------- 1. Create (or reuse) our peer ---------- */
const peer   = new Peer();            // uses free Cloud PeerServer :contentReference[oaicite:0]{index=0}
const logBox = document.getElementById('log');
let   conn   = null;                  // active DataConnection

peer.on('open', id => document.getElementById('my-id').textContent = id);

/* ---------- 2. Handle incoming connection ---------- */
peer.on('connection', c => {
  if (conn) c.close();                // allow only one chat at a time
  setupConnection(c);
});

/* ---------- 3. â€œConnectâ€ button handler ---------- */
document.getElementById('btn-connect').onclick = () => {
  const id = document.getElementById('remote-id').value.trim();
  if (!id) return alert('Enter a peer ID first!');
  setupConnection(peer.connect(id));
};

/* ---------- 4. Common DataConnection wiring ---------- */
function setupConnection(c){
  conn = c;
  document.getElementById('status').textContent = `Status: connecting to ${c.peer}â€¦`;
  c.on('open', () => {
    document.getElementById('status').textContent = `Status: connected to ${c.peer}`;
    document.getElementById('form-msg').style.display = '';
    log(`ðŸ•¹ Connected to ${c.peer}`);
  });
  c.on('data',  d => log(`ðŸ‘¤Â ${c.peer}: ${d}`));
  c.on('close', () => {
    log(`âŒ Connection to ${c.peer} closed`);
    document.getElementById('status').textContent = 'Status: disconnected';
    document.getElementById('form-msg').style.display = 'none';
    conn = null;
  });
}

/* ---------- 5. Sendâ€‘message form ---------- */
document.getElementById('form-msg').addEventListener('submit', e=>{
  e.preventDefault();
  const txt = document.getElementById('msg').value;
  if (!txt || !conn?.open) return;
  conn.send(txt);
  log(`ðŸ˜ŠÂ Me: ${txt}`);
  e.target.reset();
});

/* ---------- 6. Tiny logger ---------- */
function log(text){
  logBox.textContent += text + '\n';
  logBox.scrollTop    = logBox.scrollHeight;
}
</script>
</body>
</html>
