<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Peerâ€‘toâ€‘Peer Chat (PeerJS)</title>
<style>
  body{font-family:sans-serif;max-width:540px;margin:40px auto}
  #log{border:1px solid #ccc;height:240px;overflow-y:auto;padding:8px;margin-bottom:8px;white-space:pre-wrap}
  #controls > *{margin:4px 0}
</style>

<!-- exact version to avoid breaking changes -->
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>
<h2>P2PÂ Chat test</h2>

<div id="controls">
  <p>Your ID: <strong id="my-id">â€¦</strong></p>
  <label>
    Connect to peer ID:
    <input id="remote-id" placeholder="paste partner's ID" />
    <button id="btn-connect">Connect</button>
  </label>
</div>

<div id="status">Status: <em>waiting for connectionâ€¦</em></div>
<div id="log"></div>

<form id="form-msg" style="display:none">
  <input id="msg" autocomplete="off" placeholder="type message" style="width:70%" />
  <button>Send</button>
</form>

<script>
/* ---------- 1. Create peer with debug + error handlers ---------- */
const peer   = new Peer({ debug: 3 });    // âš ï¸Â new
const logBox = document.getElementById('log');
let   conn   = null;

peer.on('open', id => document.getElementById('my-id').textContent = id);
peer.on('error', err => {                 // âš ï¸Â new
  console.error('PeerJS', err);
  log('âš ï¸ ' + err.type + ': ' + err.message);
});

/* ---------- 2. Incoming connection ---------- */
peer.on('connection', c => { if (conn) c.close(); setup(c); });

/* ---------- 3. Manual connect ---------- */
document.getElementById('btn-connect').onclick = () => {
  const id = document.getElementById('remote-id').value.trim();
  if (!id) return alert('Enter a peer ID first!');
  setup(peer.connect(id));
};

/* ---------- utilities ---------- */
function setup(c){
  conn = c;
  document.getElementById('status').textContent = `Status: connecting to ${c.peer}â€¦`;
  c.on('open', () => {
    document.getElementById('status').textContent = `Status: connected to ${c.peer}`;
    document.getElementById('form-msg').style.display = '';
    log(`ðŸŸ¢ Connected to ${c.peer}`);
  });
  c.on('data',  d => log(`ðŸ‘¤Â ${c.peer}: ${d}`));
  c.on('close', () => {
    log(`âŒ Connection to ${c.peer} closed`);
    document.getElementById('status').textContent = 'Status: disconnected';
    document.getElementById('form-msg').style.display = 'none';
    conn = null;
  });
}

document.getElementById('form-msg').addEventListener('submit', e=>{
  e.preventDefault();
  const txt = msg.value;
  if (!txt || !conn?.open) return;
  conn.send(txt);
  log(`ðŸ˜ŠÂ Me: ${txt}`);
  e.target.reset();
});

function log(t){ logBox.textContent += t + '\n'; logBox.scrollTop = logBox.scrollHeight; }
</script>
</body>
</html>
